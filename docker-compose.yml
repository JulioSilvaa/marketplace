services:
  # ---------- REDIS (Cache e Filas) ----------
  redis:
    image: redis:7-alpine
    container_name: lazer-redis
    restart: always
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    profiles: [dev, prod]

  # ---------- POSTGRES DEV ----------
  db-dev:
    image: postgres:15-alpine
    container_name: lazer-db-dev
    ports:
      - "5432:5432"
    env_file: [.env]
    environment:
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev
      POSTGRES_DB: marketplace_dev
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    networks:
      - app-network
    profiles: [dev]

  # ---------- APP DEV (O QUE ESTAVA FALTANDO) ----------
  app-dev:
    image: node:20-alpine
    container_name: app-dev
    working_dir: /app
    ports:
      - "3000:3000"
    env_file: [.env]
    volumes:
      - .:/app
      - node_modules_dev:/app/node_modules
    # Comando para instalar, gerar prisma e rodar com hot-reload
    command: sh -c "yarn install && npx prisma generate && yarn dev"
    depends_on:
      db-dev:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - app-network
    profiles: [dev]
    
  # ---------- MONITORAMENTO (Uptime Kuma) ----------
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: always
    ports:
      - "3001:3001"
    volumes:
      - uptime-kuma-data:/app/data
    networks:
      - app-network
    profiles: [prod]

  # ---------- MIGRATE PROD ----------
  migrate-prod:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - .:/app
    command: sh -c "yarn install --production && npx prisma migrate deploy"
    env_file: [.env]
    profiles: [prod]

  # ---------- APP PROD ----------
  app-prod:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    container_name: app-prod
    restart: always
    ports:
      - "3000:3000"
    env_file: [.env]
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app-network
    profiles: [prod]

volumes:
  postgres_dev_data:
  uptime-kuma-data:
  node_modules_dev: # Volume para n√£o misturar node_modules do PC com o do Docker

networks:
  app-network:
    driver: bridge