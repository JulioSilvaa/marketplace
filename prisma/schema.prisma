generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model spaces {
  id                String   @id
  owner_id          String
  category_id       Int?
  title             String
  description       String
  capacity          Int?
  price_per_weekend Float?
  price_per_day     Float?
  comfort           String[]
  specifications    Json?
  images            String[]
  status            String   @default("active")
  street            String
  number            String
  complement        String?
  neighborhood      String
  city              String
  state             String
  zipcode           String
  country           String
  contact_whatsapp  String?
  contact_phone     String?
  contact_email     String?
  contact_instagram String?
  contact_facebook  String?
  created_at        DateTime @default(now())
  updated_at        DateTime @default(now()) @updatedAt
  users             users             @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  reviews           Review[]
  activity_events   activity_events[]
  review_replies    review_replies[]
  subscriptions     subscriptions[]

  @@index([owner_id])
  @@index([status])
  @@index([city])
  @@index([title])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model subscriptions {
  id                     String    @id
  user_id                String
  space_id               String? // Optional for now to support data migration if needed, but ideally linked.
  stripe_subscription_id String?
  plan                   String
  price                  Float
  status                 String
  trial_until            DateTime?
  next_billing_date      DateTime?
  users                  users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  spaces                 spaces?   @relation(fields: [space_id], references: [id])

  @@index([user_id])
  @@index([status])
  @@index([space_id])
  @@index([stripe_subscription_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model users {
  id                    String                  @id
  email                 String                  @unique
  name                  String
  phone                 String
  password              String
  role                  Role                    @default(user)
  checked               Boolean                 @default(false)
  status                Status                  @default(active)
  stripe_customer_id    String?
  spaces                spaces[]
  subscriptions         subscriptions[]
  password_reset_tokens password_reset_tokens[]
  reviews               Review[]
  activity_events       activity_events[]
  review_replies        review_replies[]
  whatsapp              String?
  facebook_url          String?
  instagram_url         String?
  created_at            DateTime                @default(now())
  updated_at            DateTime                @default(now()) @updatedAt

  @@index([name])
  @@index([status])
  @@index([role])
}

model Review {
  id             String   @id
  space_id       String
  user_id        String?
  reviewer_name  String?
  rating         Int
  comment        String
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  spaces         spaces   @relation(fields: [space_id], references: [id], onDelete: Cascade)
  users          users?   @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([space_id])
  @@index([user_id])
  @@map("reviews")
  review_replies review_replies[]
}

/// This model stores password reset tokens
model password_reset_tokens {
  id         String   @id
  user_id    String
  token      String   @unique
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([user_id])
}

enum Status {
  active
  inactive
}

enum Role {
  user
  admin
}

/// This model stores activity events for analytics
model activity_events {
  id         String   @id
  listing_id String
  user_id    String?
  event_type String
  metadata   Json?
  created_at DateTime @default(now())
  spaces     spaces   @relation(fields: [listing_id], references: [id], onDelete: Cascade)
  users      users?   @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([listing_id])
  @@index([user_id])
  @@index([event_type])
  @@index([created_at])
}

model review_replies {
  id            String   @id
  review_id     String   @unique
  listing_id    String
  owner_user_id String
  reply_text    String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  review        Review   @relation(fields: [review_id], references: [id], onDelete: Cascade)
  space         spaces   @relation(fields: [listing_id], references: [id], onDelete: Cascade)
  owner         users    @relation(fields: [owner_user_id], references: [id], onDelete: Cascade)

  @@index([review_id])
  @@index([listing_id])
  @@index([owner_user_id])
}
