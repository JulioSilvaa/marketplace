generator client {
  provider      = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  extensions = [unaccent]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model spaces {
  id                String   @id
  owner_id          String
  category_id       Int?
  title             String
  description       String
  capacity          Int?
  price_per_weekend Float?
  price_per_day     Float?
  comfort           String[]
  specifications    Json?
  images            String[]
  status            String   @default("active")
  views             Int      @default(0)
  street            String
  number            String
  complement        String?
  neighborhood      String
  city              String
  state             String
  zipcode           String
  country           String
  contact_whatsapp  String?
  contact_phone     String?
  contact_email     String?
  contact_instagram String?
  contact_facebook  String?
  contact_whatsapp_alternative String?
  created_at        DateTime @default(now())
  updated_at        DateTime @default(now()) @updatedAt
  users             users             @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  category          categories?       @relation(fields: [category_id], references: [id])
  reviews           Review[]
  activity_events   activity_events[]
  review_replies    review_replies[]
  subscriptions     subscriptions[]

  @@index([owner_id])
  @@index([status])
  @@index([city])
  @@index([title])
  @@index([category_id])
  @@index([state])
  @@index([neighborhood])
  @@index([price_per_day])
  @@index([price_per_weekend])
}

model categories {
  id    Int      @id @default(autoincrement())
  name  String   @unique
  spaces spaces[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model subscriptions {
  id                     String    @id
  user_id                String
  space_id               String? // Optional for now to support data migration if needed, but ideally linked.
  stripe_subscription_id String?
  plan                   String
  price                  Float
  status                 String
  trial_until            DateTime?
  next_billing_date      DateTime?
  cancel_at_period_end   Boolean   @default(false)
  coupon_code            String?
  users                  users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  spaces                 spaces?   @relation(fields: [space_id], references: [id])
  created_at             DateTime  @default(now())
  updated_at             DateTime  @default(now()) @updatedAt

  @@index([user_id])
  @@index([status])
  @@index([space_id])
  @@index([stripe_subscription_id])
  @@index([created_at])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model users {
  id                    String                  @id
  email                 String                  @unique
  name                  String
  phone                 String
  password              String
  role                  Role                    @default(user)
  checked               Boolean                 @default(false)
  status                Status                  @default(active)
  stripe_customer_id    String?
  spaces                spaces[]
  subscriptions         subscriptions[]
  password_reset_tokens password_reset_tokens[]
  reviews               Review[]
  activity_events       activity_events[]
  review_replies        review_replies[]

  created_at            DateTime                @default(now())
  updated_at            DateTime                @default(now()) @updatedAt

  @@index([name])
  @@index([status])
  @@index([role])
}

model Review {
  id             String   @id
  space_id       String
  user_id        String?
  reviewer_name  String?
  rating         Int
  comment        String
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  spaces         spaces   @relation(fields: [space_id], references: [id], onDelete: Cascade)
  users          users?   @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([space_id])
  @@index([user_id])
  @@map("reviews")
  review_replies review_replies[]
}

/// This model stores password reset tokens
model password_reset_tokens {
  id         String   @id
  user_id    String
  token      String   @unique
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([user_id])
}

enum Status {
  active
  inactive
}

enum Role {
  user
  admin
}

/// This model stores activity events for analytics
model activity_events {
  id         String   @id
  listing_id String
  user_id    String?
  event_type String
  metadata   Json?
  created_at DateTime @default(now())
  spaces     spaces   @relation(fields: [listing_id], references: [id], onDelete: Cascade)
  users      users?   @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([listing_id])
  @@index([user_id])
  @@index([event_type])
  @@index([created_at])
}

model review_replies {
  id            String   @id
  review_id     String   @unique
  listing_id    String
  owner_user_id String
  reply_text    String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  review        Review   @relation(fields: [review_id], references: [id], onDelete: Cascade)
  space         spaces   @relation(fields: [listing_id], references: [id], onDelete: Cascade)
  owner         users    @relation(fields: [owner_user_id], references: [id], onDelete: Cascade)

  @@index([review_id])
  @@index([owner_user_id])
}

model admin_users {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String
  role          String    @default("admin") // 'super_admin' or 'admin'
  created_at    DateTime  @default(now())
  last_login_at DateTime?
  updated_at    DateTime  @default(now()) @updatedAt

  @@index([email])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String   // e.g., 'LOGIN', 'CREATE_SPACE'
  resourceId String?  // ID of the affected resource (Space ID, etc.)
  details    Json?    // Extra details (e.g., changed fields)
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
